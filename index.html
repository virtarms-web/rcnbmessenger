<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp RCNB Desktop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --wa-teal: #075E54;
            --wa-teal-light: #128C7E;
            --wa-bg: #E5DDD5;
            --wa-me: #DCF8C6;
            --wa-them: #FFFFFF;
        }
        body { background: #D2DBDC; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ */
        #main-wrapper { 
            width: 100%; max-width: 1600px; height: 95vh; 
            background: #F0F2F5; display: flex; flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden;
        }

        .wa-header { background: var(--wa-teal); color: white; flex-shrink: 0; }
        .tab-btn { opacity: 0.6; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { opacity: 1; border-bottom: 3px solid white; }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ */
        .tab-content { display: none; flex: 1; overflow: hidden; background: white; }
        .tab-content.active { display: flex; }

        /* –ß–∞—Ç –∫–∞–∫ –≤ WhatsApp Web */
        .chat-layout { display: flex; width: 100%; height: 100%; }
        .side-panel { width: 350px; border-right: 1px solid #ddd; background: white; flex-shrink: 0; }
        .chat-area { flex: 1; background: var(--wa-bg); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; flex-direction: column; }

        .bubble { max-width: 65%; padding: 8px 12px; margin-bottom: 4px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .bubble-me { background: var(--wa-me); align-self: flex-end; }
        .bubble-them { background: var(--wa-them); align-self: flex-start; }

        /* –ì–î–ó –Ω–∞ –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É */
        #tab-gdz { padding: 0 !important; margin: 0 !important; }
        #gdz-frame { width: 100%; height: 100%; border: none; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        #toast { 
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%); 
            background: #323232; color: white; padding: 15px 30px; border-radius: 8px; 
            z-index: 9999; transition: 0.5s; font-weight: bold;
        }
        #toast.show { top: 20px; }
    </style>
</head>
<body>

    <div id="toast">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>

    <div id="auth-screen" class="fixed inset-0 z-[1000] bg-[#F0F2F5] flex items-center justify-center">
        <div class="bg-white p-10 rounded shadow-xl text-center max-w-sm w-full">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" class="w-16 mx-auto mb-6">
            <h1 class="text-2xl font-bold mb-8 text-gray-700">WhatsApp RCNB Desktop</h1>
            <button id="login-btn" class="bg-[#25D366] text-white w-full py-3 rounded font-bold uppercase hover:bg-[#20bd5a] transition">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
        </div>
    </div>

    <div id="main-wrapper" class="hidden">
        
        <header class="wa-header px-6 py-3 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <img id="my-avatar" class="w-10 h-10 rounded-full bg-gray-200">
                    <span class="font-bold text-lg">RCNB Messenger</span>
                </div>
                <button onclick="auth.signOut()" class="text-xs font-bold opacity-80 hover:opacity-100 uppercase">–í—ã–π—Ç–∏</button>
            </div>
            <div class="flex gap-8">
                <button onclick="setTab('chats')" id="btn-chats" class="tab-btn active pb-2 text-sm font-bold uppercase">–ß–∞—Ç—ã</button>
                <button onclick="setTab('users')" id="btn-users" class="tab-btn pb-2 text-sm font-bold uppercase">–õ—é–¥–∏</button>
                <button onclick="setTab('feed')" id="btn-feed" class="tab-btn pb-2 text-sm font-bold uppercase">–õ–µ–Ω—Ç–∞</button>
                <button onclick="setTab('lessons')" id="btn-lessons" class="tab-btn pb-2 text-sm font-bold uppercase">–£—Ä–æ–∫–∏</button>
                <button onclick="setTab('gdz')" id="btn-gdz" class="tab-btn pb-2 text-sm font-bold uppercase">–ì–î–ó</button>
            </div>
        </header>

        <main class="flex-1 relative flex overflow-hidden">
            
            <section id="tab-chats" class="tab-content active">
                <div class="chat-layout">
                    <div class="side-panel overflow-y-auto" id="friends-list">
                        </div>
                    <div class="chat-area">
                        <div id="chat-placeholder" class="flex-1 flex items-center justify-center text-gray-400 flex-col">
                            <div class="w-24 h-24 bg-gray-200 rounded-full mb-4 flex items-center justify-center">üì±</div>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                        </div>
                        <div id="active-chat-window" class="hidden flex flex-col h-full">
                            <header class="bg-[#F0F2F5] p-3 flex items-center gap-3 border-b">
                                <img id="active-avatar" class="w-10 h-10 rounded-full">
                                <span id="active-name" class="font-bold">–ò–º—è</span>
                            </header>
                            <div id="messages-box" class="flex-1 p-6 overflow-y-auto flex flex-col"></div>
                            <form id="chat-form" class="bg-[#F0F2F5] p-3 flex gap-2">
                                <input id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" class="flex-1 py-3 px-5 rounded-lg outline-none">
                                <button class="bg-[#075E54] text-white px-6 rounded-lg font-bold uppercase">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tab-users" class="tab-content flex-col p-8 overflow-y-auto bg-[#F0F2F5]">
                <div class="max-w-4xl mx-auto w-full">
                    <h2 class="text-xl font-bold mb-6 text-gray-600 uppercase">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
                    <div id="users-list" class="grid grid-cols-2 gap-4 mb-10"></div>
                    <h2 class="text-xl font-bold mb-6 text-orange-600 uppercase">–ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è</h2>
                    <div id="req-list" class="grid grid-cols-2 gap-4"></div>
                </div>
            </section>

            <section id="tab-feed" class="tab-content flex-col p-8 overflow-y-auto bg-[#F0F2F5]">
                <div class="max-w-2xl mx-auto w-full">
                    <div class="bg-white p-6 rounded shadow-sm mb-6">
                        <textarea id="feed-text" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?" class="w-full border-none outline-none resize-none mb-4" rows="3"></textarea>
                        <div class="flex justify-between items-center">
                            <input type="file" id="feed-file" class="hidden" accept="video/*">
                            <button onclick="document.getElementById('feed-file').click()" class="text-teal-600 font-bold text-sm">+ –í–ò–î–ï–û</button>
                            <button id="post-btn" class="bg-[#25D366] text-white px-8 py-2 rounded font-bold">–ü–û–°–¢</button>
                        </div>
                        <div id="up-bar" class="hidden h-1 bg-green-500 mt-4 transition-all w-0"></div>
                    </div>
                    <div id="feed-items" class="space-y-6"></div>
                </div>
            </section>

            <section id="tab-lessons" class="tab-content p-8 bg-[#F0F2F5]">
                <div class="max-w-4xl mx-auto w-full grid grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold uppercase text-sm">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h3>
                            <button onclick="exportToExcel()" class="text-[10px] bg-green-600 text-white px-2 py-1 rounded">EXCEL</button>
                        </div>
                        <div id="sch-view" class="space-y-2 mb-4"></div>
                        <div class="flex gap-2">
                            <input id="s-n" placeholder="–ü—Ä–µ–¥–º–µ—Ç" class="border p-2 text-sm flex-1">
                            <input id="s-t" type="time" class="border p-2 text-sm">
                            <button onclick="addS()" class="bg-teal-700 text-white px-3 font-bold">+</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-bold uppercase text-sm mb-4">–û—Ü–µ–Ω–∫–∏</h3>
                        <div id="g-view" class="space-y-2 mb-4"></div>
                        <div class="flex gap-2">
                            <input id="g-n" placeholder="–ü—Ä–µ–¥–º–µ—Ç" class="border p-2 text-sm flex-1">
                            <input id="g-v" type="number" class="border p-2 text-sm w-16">
                            <button onclick="addG()" class="bg-orange-600 text-white px-3 font-bold">+</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tab-gdz" class="tab-content">
                <iframe src="https://gdz.ru" id="gdz-frame"></iframe>
            </section>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDocs, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDch7p3qsay4twoc3GcXI2Z7YI5iHazuHs",
            authDomain: "rcnb-messenger.firebaseapp.com",
            projectId: "rcnb-messenger",
            storageBucket: "rcnb-messenger.firebasestorage.app",
            messagingSenderId: "131047901393",
            appId: "1:131047901393:web:d6f5ae21a875b6aef75df0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();
        const notifySound = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

        let activeFriendId = null;
        let schoolData = { schedule: [], grades: [] };

        // --- AUTH ---
        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-wrapper').classList.remove('hidden');
                document.getElementById('my-avatar').src = user.photoURL;
                await setDoc(doc(db, 'users', user.uid), { uid: user.uid, name: user.displayName, photo: user.photoURL }, { merge: true });
                initAll();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        function initAll() {
            loadFriends();
            loadUsers();
            loadFeed();
            listenGlobal();
        }

        window.setTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`btn-${tab}`).classList.add('active');
        };

        // NOTIFICATIONS
        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            notifySound.play();
            setTimeout(() => t.classList.remove('show'), 5000);
        }

        function listenGlobal() {
            const q = query(collection(db, "global_messages"), orderBy("createdAt", "desc"));
            let first = true;
            onSnapshot(q, (snap) => {
                if(!first && snap.docs[0]) {
                    const m = snap.docs[0].data();
                    if(m.uid !== auth.currentUser.uid) toast(`${m.name}: ${m.text}`);
                }
                first = false;
            });
        }

        // --- DMs ---
        function loadFriends() {
            onSnapshot(collection(db, `users/${auth.currentUser.uid}/friends`), (snap) => {
                const list = document.getElementById('friends-list'); list.innerHTML = '';
                snap.forEach(async d => {
                    const u = (await getDocs(query(collection(db, "users"), where("uid", "==", d.id)))).docs[0].data();
                    list.innerHTML += `
                        <div onclick="openChat('${u.uid}', '${u.name}', '${u.photo}')" class="flex items-center gap-4 p-4 border-b hover:bg-gray-50 cursor-pointer bg-white">
                            <img src="${u.photo}" class="w-12 h-12 rounded-full">
                            <div><p class="font-bold">${u.name}</p><p class="text-xs text-gray-400">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç</p></div>
                        </div>`;
                });
            });
        }

        window.openChat = (uid, name, photo) => {
            activeFriendId = uid;
            document.getElementById('chat-placeholder').classList.add('hidden');
            document.getElementById('active-chat-window').classList.remove('hidden');
            document.getElementById('active-name').innerText = name;
            document.getElementById('active-avatar').src = photo;
            
            const cid = [auth.currentUser.uid, uid].sort().join('_');
            onSnapshot(query(collection(db, `chats/${cid}/messages`), orderBy("createdAt", "asc")), (snap) => {
                const box = document.getElementById('messages-box'); box.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data(); const isMe = m.uid === auth.currentUser.uid;
                    box.innerHTML += `<div class="bubble ${isMe ? 'bubble-me' : 'bubble-them'}">${m.text}</div>`;
                });
                box.scrollTo(0, box.scrollHeight);
            });
        };

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault(); const i = document.getElementById('chat-input');
            if(!i.value.trim() || !activeFriendId) return;
            const cid = [auth.currentUser.uid, activeFriendId].sort().join('_');
            await addDoc(collection(db, `chats/${cid}/messages`), { text: i.value, uid: auth.currentUser.uid, createdAt: serverTimestamp() });
            await addDoc(collection(db, "global_messages"), { text: i.value, uid: auth.currentUser.uid, name: auth.currentUser.displayName, createdAt: serverTimestamp() });
            i.value = '';
        };

        // --- USERS ---
        async function loadUsers() {
            const snap = await getDocs(collection(db, "users"));
            const list = document.getElementById('users-list'); list.innerHTML = '';
            snap.forEach(d => {
                const u = d.data(); if(u.uid === auth.currentUser.uid) return;
                list.innerHTML += `<div class="bg-white p-4 rounded shadow-sm flex justify-between items-center"><div class="flex items-center gap-3"><img src="${u.photo}" class="w-8 h-8 rounded-full"> <span class="text-sm font-bold">${u.name}</span></div><button onclick="sendReq('${u.uid}')" class="text-xs text-teal-600 font-bold">–î–û–ë–ê–í–ò–¢–¨</button></div>`;
            });
            onSnapshot(query(collection(db, "friendRequests"), where("to", "==", auth.currentUser.uid)), (snap) => {
                const rl = document.getElementById('req-list'); rl.innerHTML = '';
                snap.forEach(d => { rl.innerHTML += `<div class="bg-white p-4 rounded border-l-4 border-orange-500 flex justify-between items-center"><span class="text-sm font-bold">${d.data().fromName}</span><button onclick="acceptReq('${d.id}', '${d.data().from}')" class="bg-orange-500 text-white px-3 py-1 rounded text-xs">–ü–†–ò–ù–Ø–¢–¨</button></div>`; });
            });
        }
        window.sendReq = async (id) => { await addDoc(collection(db, "friendRequests"), { from: auth.currentUser.uid, fromName: auth.currentUser.displayName, to: id }); alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"); };
        window.acceptReq = async (rid, fid) => {
            await setDoc(doc(db, `users/${auth.currentUser.uid}/friends`, fid), { uid: fid });
            await setDoc(doc(db, `users/${fid}/friends`, auth.currentUser.uid), { uid: auth.currentUser.uid });
            await deleteDoc(doc(db, "friendRequests", rid)); location.reload();
        };

        // --- FEED ---
        document.getElementById('post-btn').onclick = async () => {
            const f = document.getElementById('feed-file').files[0]; const t = document.getElementById('feed-text').value;
            let url = null;
            if(f) {
                const r = ref(storage, `v/${Date.now()}`); const task = uploadBytesResumable(r, f);
                task.on('state_changed', (s) => {
                    document.getElementById('up-bar').classList.remove('hidden');
                    document.getElementById('up-bar').style.width = (s.bytesTransferred/s.totalBytes*100)+'%';
                }, null, async () => {
                    url = await getDownloadURL(task.snapshot.ref);
                    await addDoc(collection(db, "posts"), { content: t, video: url, photo: auth.currentUser.photoURL, name: auth.currentUser.displayName, createdAt: serverTimestamp() });
                    document.getElementById('up-bar').classList.add('hidden');
                    document.getElementById('feed-text').value = '';
                });
            } else if(t) {
                await addDoc(collection(db, "posts"), { content: t, video: null, photo: auth.currentUser.photoURL, name: auth.currentUser.displayName, createdAt: serverTimestamp() });
                document.getElementById('feed-text').value = '';
            }
        };
        function loadFeed() {
            onSnapshot(query(collection(db, "posts"), orderBy("createdAt", "desc")), (snap) => {
                const fi = document.getElementById('feed-items'); fi.innerHTML = '';
                snap.forEach(d => {
                    const p = d.data();
                    fi.innerHTML += `<div class="bg-white p-6 rounded shadow-sm"><div class="flex items-center gap-3 mb-4"><img src="${p.photo}" class="w-8 h-8 rounded-full"><span class="font-bold text-sm">${p.name}</span></div><p class="mb-4">${p.content}</p>${p.video ? `<video src="${p.video}" controls class="w-full rounded"></video>` : ''}</div>`;
                });
            });
        }

        // --- SCHOOL ---
        window.addS = () => { schoolData.schedule.push({n:document.getElementById('s-n').value, t:document.getElementById('s-t').value}); renderL(); };
        window.addG = () => { schoolData.grades.push({n:document.getElementById('g-n').value, v:document.getElementById('g-v').value}); renderL(); };
        function renderL() {
            document.getElementById('sch-view').innerHTML = schoolData.schedule.map(i => `<div class="flex justify-between p-2 bg-gray-50 text-xs font-bold border-b"><span>${i.n}</span><span>${i.t}</span></div>`).join('');
            document.getElementById('g-view').innerHTML = schoolData.grades.map(i => `<div class="flex justify-between p-2 bg-gray-50 text-xs font-bold border-b"><span>${i.n}</span><span class="text-orange-600">${i.v}</span></div>`).join('');
        }
        window.exportToExcel = () => {
            let csv = "Subject,Grade\n" + schoolData.grades.map(g => `${g.n},${g.v}`).join("\n");
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'report.csv'; a.click();
        };

    </script>
</body>
</html>
