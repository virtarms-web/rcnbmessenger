<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCNB Social | Official + Calls</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --main: #00a884; --bg: #111b21; --panel: #202c33; --sidebar-dark: #182229; --text: #e9edef; --msg-out: #005c4b; --msg-in: #202c33; }
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; background: #0c1317; color: var(--text); overflow: hidden; }
        #main-app { display: none; height: 100vh; grid-template-columns: 60px 350px 1fr; }

        /* НАВИГАЦИЯ */
        .nav-rail { background: var(--sidebar-dark); display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 25px; border-right: 1px solid #313d45; }
        .nav-item { color: #8696a0; font-size: 22px; cursor: pointer; transition: 0.3s; position: relative; width: 100%; text-align: center; padding: 10px 0; }
        .nav-item:hover, .nav-item.active { color: var(--main); }
        .nav-item.active::after { content: ''; position: absolute; left: 0; top: 10px; height: 25px; width: 3px; background: var(--main); }

        /* САЙДБАР */
        .sidebar { background: var(--panel); display: flex; flex-direction: column; border-right: 1px solid #313d45; overflow: hidden; }
        .sidebar-user-profile { padding: 15px; background: #2a3942; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #313d45; }
        .sidebar-user-profile img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main); }
        .sidebar-title { padding: 15px 15px 5px 15px; font-size: 14px; font-weight: bold; color: var(--main); text-transform: uppercase; letter-spacing: 1px; }
        .list-container { flex: 1; overflow-y: auto; }
        .contact { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #222d34; }
        .contact:hover { background: #2a3942; }
        .contact img { width: 45px; height: 45px; border-radius: 50%; margin-right: 15px; object-fit: cover; }

        /* ЧАТ */
        .content-area { position: relative; height: 100%; }
        #chat-view { display: flex; flex-direction: column; height: 100%; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: rgba(11,27,33,0.9); background-blend-mode: overlay; }
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 14px; color: white; }
        .msg.sent { align-self: flex-end; background: var(--msg-out); }
        .msg.received { align-self: flex-start; background: var(--msg-in); }

        /* ЗВОНКИ (UI) */
        #call-overlay { display: none; position: absolute; inset: 0; background: #000; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 140px; position: absolute; bottom: 100px; right: 20px; border-radius: 10px; border: 2px solid var(--main); background: #111; z-index: 1001; }
        .call-btns { position: absolute; bottom: 40px; display: flex; gap: 20px; z-index: 1002; }
        .c-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; }

        /* ЛЕНТА И НАСТРОЙКИ */
        #feed-view { display: none; flex-direction: column; height: 100%; background: #0b141a; overflow-y: auto; padding: 20px; align-items: center; }
        .post-card { background: var(--panel); border-radius: 12px; width: 100%; max-width: 600px; padding: 15px; margin-bottom: 20px; border: 1px solid #313d45; }
        #settings-view { display: none; height: 100%; background: var(--bg); padding: 50px; overflow-y: auto; }
        .settings-card { max-width: 500px; margin: 0 auto; background: var(--panel); padding: 30px; border-radius: 15px; display: flex; flex-direction: column; gap: 20px; }
        .btn-main { background: var(--main); color: white; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        input[type="text"] { background: #2a3942; border: 1px solid #313d45; padding: 12px; border-radius: 8px; color: white; outline: none; }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: var(--bg); }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color: var(--main); font-size: 60px; margin-bottom: 20px;">RCNB</h1>
        <button class="btn-main" onclick="login()" style="padding: 15px 40px; border-radius: 30px;">Войти через Google</button>
    </div>

    <div id="main-app">
        <div id="call-overlay">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div style="position:absolute; top:50px; text-align:center; color:white; z-index:1003">
                <h2 id="call-status">Вызов...</h2>
            </div>
            <div class="call-btns">
                <button id="btn-ans" class="c-btn" style="background:#25d366; display:none"><i class="fa fa-phone"></i></button>
                <button onclick="hangUp()" class="c-btn" style="background:#ea4335"><i class="fa fa-phone-slash"></i></button>
            </div>
        </div>

        <div class="nav-rail">
            <div class="nav-item active" id="btn-chats" onclick="showView('chat')"><i class="fa fa-comment-dots"></i></div>
            <div class="nav-item" id="btn-feed" onclick="showView('feed')"><i class="fa fa-newspaper"></i></div>
            <div class="nav-item" id="btn-all" onclick="showView('all')"><i class="fa fa-users"></i></div>
            <div class="nav-item" id="btn-settings" onclick="showView('settings')"><i class="fa fa-cog"></i></div>
            <div class="nav-item" onclick="logout()" style="margin-top: auto;"><i class="fa fa-sign-out-alt"></i></div>
        </div>

        <div class="sidebar">
            <div class="sidebar-user-profile">
                <img id="my-profile-pic" src="">
                <b id="my-profile-name">Загрузка...</b>
            </div>
            <div id="sidebar-label" class="sidebar-title">ЧАТЫ</div>
            <div class="list-container" id="sidebar-list"></div>
        </div>

        <div class="content-area">
            <div id="chat-view">
                <div id="chat-header" style="padding: 10px 20px; background: var(--panel); height: 60px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #313d45;">
                    <span id="chat-title" style="color:#8696a0">Выберите диалог</span>
                    <div id="call-tools" style="display:none; gap:20px">
                        <i class="fa fa-phone" onclick="makeCall(false)" style="color:var(--main); cursor:pointer"></i>
                        <i class="fa fa-video" onclick="makeCall(true)" style="color:var(--main); cursor:pointer"></i>
                    </div>
                </div>
                <div class="messages" id="messages"></div>
                <div style="padding: 15px; background: var(--panel); display: flex; gap: 15px;">
                    <input type="text" id="msg-input" placeholder="Сообщение..." style="flex:1" onkeypress="if(event.key==='Enter') sendMsg()">
                    <button onclick="sendMsg()" class="btn-main"><i class="fa fa-paper-plane"></i></button>
                </div>
            </div>

            <div id="feed-view">
                <div class="post-card">
                    <textarea id="post-text" placeholder="Что нового?" style="width: 100%; height: 70px; background: #111b21; border: none; padding: 10px; color: white; border-radius: 8px; resize: none; outline: none;"></textarea>
                    <button class="btn-main" onclick="createPost()" style="width: 100%; margin-top: 10px;">Опубликовать пост</button>
                </div>
                <div id="feed-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
            </div>

            <div id="settings-view">
                <div class="settings-card">
                    <h2>Настройки профиля</h2>
                    <input type="text" id="set-name" placeholder="Никнейм">
                    <input type="text" id="set-status" placeholder="Статус">
                    <button class="btn-main" onclick="saveProfile()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDch7p3qsay4twoc3GcXI2Z7YI5iHazuHs",
        authDomain: "rcnb-messenger.firebaseapp.com",
        projectId: "rcnb-messenger",
        storageBucket: "rcnb-messenger.firebasestorage.app",
        messagingSenderId: "131047901393",
        appId: "1:131047901393:web:d6f5ae21a875b6aef75df0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore(), provider = new firebase.auth.GoogleAuthProvider();

    let me = null, activeChat = null, pc = null, localStream = null;

    auth.onAuthStateChanged(user => {
        if (user) {
            me = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'grid';
            syncUser(user);
            showView('chat');
            listenInboundCalls();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
        }
    });

    function login() { auth.signInWithPopup(provider); }
    function logout() { auth.signOut(); }

    function syncUser(u) {
        db.collection("users").doc(u.uid).onSnapshot(doc => {
            const data = doc.data() || {};
            document.getElementById('my-profile-pic').src = data.photo || u.photoURL;
            document.getElementById('my-profile-name').innerText = data.name || u.displayName;
            if(!doc.exists) db.collection("users").doc(u.uid).set({ name: u.displayName, photo: u.photoURL, uid: u.uid });
        });
    }

    function showView(view) {
        document.getElementById('chat-view').style.display = (view === 'chat' || view === 'all') ? 'flex' : 'none';
        document.getElementById('feed-view').style.display = (view === 'feed') ? 'flex' : 'none';
        document.getElementById('settings-view').style.display = (view === 'settings') ? 'flex' : 'none';
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        const label = document.getElementById('sidebar-label');
        if(view === 'chat') { document.getElementById('btn-chats').classList.add('active'); label.innerText = "ВАШИ ЧАТЫ"; loadSidebar('chats'); }
        if(view === 'feed') { document.getElementById('btn-feed').classList.add('active'); label.innerText = "ЛЕНТА"; loadFeed(); }
        if(view === 'all') { document.getElementById('btn-all').classList.add('active'); label.innerText = "ВСЕ ЛЮДИ"; loadSidebar('all'); }
        if(view === 'settings') { document.getElementById('btn-settings').classList.add('active'); label.innerText = "НАСТРОЙКИ"; }
    }

    function loadSidebar(type) {
        db.collection("users").onSnapshot(snap => {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                if(u.uid !== me.uid) {
                    list.innerHTML += `<div class="contact" onclick="openChat('${u.uid}', '${u.name}')">
                        <img src="${u.photo}"><div><div style="font-weight:bold">${u.name}</div><div style="font-size:11px;color:#8696a0">${u.status || ''}</div></div>
                    </div>`;
                }
            });
        });
    }

    function openChat(uid, name) {
        activeChat = uid;
        document.getElementById('chat-title').innerHTML = `<b>${name}</b>`;
        document.getElementById('call-tools').style.display = 'flex';
        loadMessages();
    }

    // ЛОГИКА ЗВОНКОВ
    async function makeCall(video) {
        document.getElementById('call-overlay').style.display = 'flex';
        localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:video});
        document.getElementById('local-video').srcObject = localStream;
        pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = e => document.getElementById('remote-video').srcObject = e.streams[0];
        
        const callDoc = db.collection('calls').doc(activeChat);
        pc.onicecandidate = e => e.candidate && callDoc.collection('offCands').add(e.candidate.toJSON());
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await callDoc.set({offer, caller:me.displayName, video});

        callDoc.onSnapshot(s => { const d = s.data(); if(d?.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(d.answer)); });
        callDoc.collection('ansCands').onSnapshot(s => s.docChanges().forEach(c => c.type==='added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
    }

    function listenInboundCalls() {
        db.collection('calls').doc(me.uid).onSnapshot(async s => {
            const d = s.data();
            if(d && d.offer && !pc) {
                document.getElementById('call-overlay').style.display = 'flex';
                document.getElementById('call-status').innerText = "Входящий от " + d.caller;
                document.getElementById('btn-ans').style.display = 'flex';
                document.getElementById('btn-ans').onclick = async () => {
                    document.getElementById('btn-ans').style.display = 'none';
                    localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:d.video});
                    document.getElementById('local-video').srcObject = localStream;
                    pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
                    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
                    pc.ontrack = e => document.getElementById('remote-video').srcObject = e.streams[0];
                    const callDoc = db.collection('calls').doc(me.uid);
                    pc.onicecandidate = e => e.candidate && callDoc.collection('ansCands').add(e.candidate.toJSON());
                    await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
                    const ans = await pc.createAnswer();
                    await pc.setLocalDescription(ans);
                    await callDoc.update({answer:ans});
                    callDoc.collection('offCands').onSnapshot(s => s.docChanges().forEach(c => c.type==='added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
                }
            }
            if(!d && pc) hangUp();
        });
    }

    function hangUp() {
        if(pc) pc.close(); if(localStream) localStream.getTracks().forEach(t => t.stop());
        pc = null; localStream = null;
        db.collection('calls').doc(me.uid).delete();
        if(activeChat) db.collection('calls').doc(activeChat).delete();
        document.getElementById('call-overlay').style.display = 'none';
    }

    // МЕССЕНДЖЕР
    function sendMsg() {
        const input = document.getElementById('msg-input');
        if(!input.value.trim() || !activeChat) return;
        db.collection("chats").doc([me.uid, activeChat].sort().join('_')).collection("messages").add({
            text: input.value, sender: me.uid, time: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = "";
    }

    function loadMessages() {
        db.collection("chats").doc([me.uid, activeChat].sort().join('_')).collection("messages").orderBy("time").onSnapshot(snap => {
            const box = document.getElementById('messages'); box.innerHTML = "";
            snap.forEach(doc => { const m = doc.data(); box.innerHTML += `<div class="msg ${m.sender === me.uid ? 'sent' : 'received'}">${m.text}</div>`; });
            box.scrollTop = box.scrollHeight;
        });
    }

    function loadFeed() {
        db.collection("posts").orderBy("time", "desc").onSnapshot(snap => {
            const container = document.getElementById('feed-container'); container.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data(); const liked = p.likes?.includes(me.uid);
                container.innerHTML += `<div class="post-card">
                    <div class="post-header"><img src="${p.authorPhoto}"><b>${p.authorName}</b></div>
                    <div style="margin:10px 0">${p.text}</div>
                    <i class="${liked ? 'fas' : 'far'} fa-heart" onclick="likePost('${doc.id}', ${liked})" style="cursor:pointer; ${liked ? 'color:red' : ''}"> ${p.likes?.length || 0}</i>
                </div>`;
            });
        });
    }

    async function likePost(id, liked) {
        db.collection("posts").doc(id).update({ likes: liked ? firebase.firestore.FieldValue.arrayRemove(me.uid) : firebase.firestore.FieldValue.arrayUnion(me.uid) });
    }

    async function createPost() {
        const text = document.getElementById('post-text').value; if(!text) return;
        const my = (await db.collection("users").doc(me.uid).get()).data();
        await db.collection("posts").add({ text, uid: me.uid, authorName: my.name, authorPhoto: my.photo, likes: [], time: firebase.firestore.FieldValue.serverTimestamp() });
        document.getElementById('post-text').value = "";
    }

    async function saveProfile() {
        await db.collection("users").doc(me.uid).update({ name: document.getElementById('set-name').value, status: document.getElementById('set-status').value });
        alert("Ок");
    }
</script>
</body>
</html>
