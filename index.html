<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>РКНБ Мессенджер</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background: #D2DBDC; font-family: 'Manrope', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #app-window { width: 95%; max-width: 1500px; height: 92vh; background: #F0F2F5; display: flex; flex-direction: column; border-radius: 12px; box-shadow: 0 10px 50px rgba(0,0,0,0.2); overflow: hidden; }
        .wa-header { background: #075E54; color: white; padding: 15px 30px; }
        .tab-btn { opacity: 0.6; font-size: 13px; font-weight: 800; text-transform: uppercase; border-bottom: 3px solid transparent; padding-bottom: 5px; transition: 0.2s; }
        .tab-btn.active { opacity: 1; border-bottom-color: white; }
        .tab-content { display: none; flex: 1; overflow: hidden; background: white; }
        .tab-content.active { display: flex; }
        
        /* Чат Десктоп */
        .side-panel { width: 380px; border-right: 1px solid #ddd; display: flex; flex-direction: column; background: #fff; }
        .chat-view { flex: 1; background: #E5DDD5 url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; flex-direction: column; }
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 8px; font-size: 14px; margin-bottom: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-me { background: #DCF8C6; align-self: flex-end; }
        .msg-them { background: #fff; align-self: flex-start; }

        /* Уведомление */
        #toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 15px 30px; border-radius: 8px; z-index: 9999; transition: 0.5s; font-weight: bold; }
        #toast.show { top: 20px; }
        
        /* ГДЗ Full */
        #gdz-frame { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="auth-screen" class="fixed inset-0 z-[1000] bg-white flex flex-col items-center justify-center">
        <h1 class="text-4xl font-black italic mb-10 text-[#075E54]">РКНБ Мессенджер</h1>
        <button id="login-btn" class="bg-[#25D366] text-white px-10 py-4 rounded-full font-black shadow-xl hover:scale-105 transition">ВОЙТИ ЧЕРЕЗ GOOGLE</button>
    </div>

    <div id="app-window" class="hidden">
        <header class="wa-header flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <span class="text-xl font-black italic">РКНБ Мессенджер</span>
                <div class="flex items-center gap-4">
                    <div id="profile-trigger" class="flex items-center gap-3 bg-black/10 p-2 rounded-full cursor-pointer hover:bg-black/20" onclick="toggleProfile()">
                        <img id="my-avatar" class="w-8 h-8 rounded-full border border-white/50 object-cover">
                        <span id="my-name-nav" class="text-sm font-bold pr-2"></span>
                    </div>
                </div>
            </div>
            <div class="flex gap-8">
                <button onclick="setTab('chats')" id="btn-chats" class="tab-btn active">Чаты</button>
                <button onclick="setTab('users')" id="btn-users" class="tab-btn">Люди</button>
                <button onclick="setTab('feed')" id="btn-feed" class="tab-btn">Лента</button>
                <button onclick="setTab('lessons')" id="btn-lessons" class="tab-btn">Уроки</button>
                <button onclick="setTab('gdz')" id="btn-gdz" class="tab-btn">ГДЗ</button>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden relative">
            
            <div id="profile-modal" class="hidden absolute top-4 right-8 w-80 bg-white shadow-2xl rounded-2xl z-[100] p-6 border">
                <h3 class="font-black mb-4 uppercase text-xs">Настройки аккаунта</h3>
                <input id="edit-name" placeholder="Никнейм" class="w-full border p-3 rounded mb-2 outline-none font-bold">
                <input id="edit-photo" placeholder="URL авы" class="w-full border p-3 rounded mb-4 outline-none text-xs">
                <button onclick="saveProfile()" class="w-full bg-[#075E54] text-white py-3 rounded font-bold mb-2">СОХРАНИТЬ</button>
                <button onclick="auth.signOut()" class="w-full text-red-500 font-bold text-xs">ВЫЙТИ</button>
            </div>

            <section id="tab-chats" class="tab-content active">
                <div class="side-panel" id="friends-list"></div>
                <div class="chat-view">
                    <div id="active-chat" class="hidden flex flex-col h-full">
                        <header class="bg-[#F0F2F5] p-3 flex items-center gap-3 border-b">
                            <img id="active-avatar" class="w-10 h-10 rounded-full">
                            <span id="active-name" class="font-bold"></span>
                        </header>
                        <div id="msg-box" class="flex-1 p-6 overflow-y-auto flex flex-col"></div>
                        <form id="chat-form" class="bg-[#F0F2F5] p-3 flex gap-2">
                            <input id="chat-input" placeholder="Сообщение" class="flex-1 py-3 px-5 rounded-full outline-none">
                            <button class="bg-[#075E54] text-white px-6 rounded-full font-bold">➤</button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="tab-users" class="tab-content flex-col p-10 overflow-y-auto bg-gray-50">
                <h2 class="font-black mb-6 uppercase text-gray-500">Поиск друзей</h2>
                <div id="users-list" class="grid grid-cols-3 gap-4 mb-10"></div>
                <h2 class="font-black mb-6 uppercase text-orange-600">Запросы</h2>
                <div id="req-list" class="grid grid-cols-3 gap-4"></div>
            </section>

            <section id="tab-feed" class="tab-content flex-col p-10 overflow-y-auto bg-gray-100">
                <div class="max-w-xl mx-auto w-full">
                    <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                        <textarea id="feed-text" placeholder="Че как?" class="w-full outline-none mb-4 resize-none"></textarea>
                        <div class="flex justify-between items-center">
                            <input type="file" id="feed-file" class="hidden" accept="video/*">
                            <button onclick="document.getElementById('feed-file').click()" class="text-teal-700 font-bold text-xs uppercase">Видео</button>
                            <button id="post-btn" class="bg-[#25D366] text-white px-8 py-2 rounded-full font-black">POST</button>
                        </div>
                    </div>
                    <div id="feed-items" class="space-y-6"></div>
                </div>
            </section>

            <section id="tab-lessons" class="tab-content p-10 bg-gray-50">
                <div class="max-w-4xl mx-auto w-full grid grid-cols-2 gap-10">
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="font-black mb-4 text-sm uppercase">Расписание</h3>
                        <div id="sch-view" class="space-y-2 mb-4"></div>
                        <div class="flex gap-2">
                            <input id="s-n" placeholder="Предмет" class="border p-2 rounded flex-1 text-sm">
                            <input id="s-t" type="time" class="border p-2 rounded text-sm">
                            <button onclick="addS()" class="bg-teal-800 text-white px-4 rounded">+</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-black text-sm uppercase">Оценки</h3>
                            <button onclick="exportExcel()" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded">EXCEL</button>
                        </div>
                        <div id="g-view" class="space-y-2 mb-4"></div>
                        <div class="flex gap-2">
                            <input id="g-n" placeholder="Предмет" class="border p-2 rounded flex-1 text-sm">
                            <input id="g-v" type="number" class="border p-2 rounded w-16 text-sm">
                            <button onclick="addG()" class="bg-orange-600 text-white px-4 rounded">+</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tab-gdz" class="tab-content">
                <iframe src="https://gdz.ru" id="gdz-frame"></iframe>
            </section>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDocs, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, where, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDch7p3qsay4twoc3GcXI2Z7YI5iHazuHs",
            authDomain: "rcnb-messenger.firebaseapp.com",
            projectId: "rcnb-messenger",
            storageBucket: "rcnb-messenger.firebasestorage.app",
            messagingSenderId: "131047901393",
            appId: "1:131047901393:web:d6f5ae21a875b6aef75df0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();
        const notifySound = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

        let currentUserData = null;
        let activeFriendId = null;
        let schoolData = { schedule: [], grades: [] };

        // AUTH
        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-window').classList.remove('hidden');
                
                const userDoc = doc(db, 'users', user.uid);
                const snap = await getDocs(query(collection(db, 'users'), where('uid', '==', user.uid)));
                
                if (snap.empty) {
                    currentUserData = { uid: user.uid, name: user.displayName, photo: user.photoURL };
                    await setDoc(userDoc, currentUserData);
                } else {
                    currentUserData = snap.docs[0].data();
                }
                
                updateUIVariables();
                initApp();
            }
        });

        function updateUIVariables() {
            document.getElementById('my-avatar').src = currentUserData.photo;
            document.getElementById('my-name-nav').innerText = currentUserData.name;
            document.getElementById('edit-name').value = currentUserData.name;
            document.getElementById('edit-photo').value = currentUserData.photo;
        }

        window.toggleProfile = () => document.getElementById('profile-modal').classList.toggle('hidden');
        
        window.saveProfile = async () => {
            const newName = document.getElementById('edit-name').value;
            const newPhoto = document.getElementById('edit-photo').value;
            await updateDoc(doc(db, 'users', auth.currentUser.uid), { name: newName, photo: newPhoto });
            currentUserData.name = newName;
            currentUserData.photo = newPhoto;
            updateUIVariables();
            toggleProfile();
            toast("Профиль обновлен!");
        };

        function initApp() {
            loadFriends();
            loadUsers();
            loadFeed();
            listenGlobal();
        }

        window.setTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`btn-${tab}`).classList.add('active');
        };

        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            notifySound.play();
            setTimeout(() => t.classList.remove('show'), 5000);
        }

        function listenGlobal() {
            onSnapshot(query(collection(db, "global_messages"), orderBy("createdAt", "desc")), (snap) => {
                if(snap.docs[0]) {
                    const m = snap.docs[0].data();
                    if(m.uid !== auth.currentUser.uid) toast(`${m.name}: ${m.text}`);
                }
            });
        }

        // --- MESSAGES ---
        function loadFriends() {
            onSnapshot(collection(db, `users/${auth.currentUser.uid}/friends`), (snap) => {
                const list = document.getElementById('friends-list'); list.innerHTML = '';
                snap.forEach(async d => {
                    const uSnap = await getDocs(query(collection(db, "users"), where("uid", "==", d.id)));
                    const u = uSnap.docs[0].data();
                    list.innerHTML += `<div onclick="openChat('${u.uid}', '${u.name}', '${u.photo}')" class="flex items-center gap-4 p-4 border-b hover:bg-gray-100 cursor-pointer">
                        <img src="${u.photo}" class="w-12 h-12 rounded-full object-cover">
                        <div><p class="font-bold text-sm">${u.name}</p><p class="text-xs text-gray-400 italic">На связи</p></div>
                    </div>`;
                });
            });
        }

        window.openChat = (uid, name, photo) => {
            activeFriendId = uid;
            document.getElementById('active-chat').classList.remove('hidden');
            document.getElementById('active-name').innerText = name;
            document.getElementById('active-avatar').src = photo;
            const cid = [auth.currentUser.uid, uid].sort().join('_');
            onSnapshot(query(collection(db, `chats/${cid}/messages`), orderBy("createdAt", "asc")), (snap) => {
                const box = document.getElementById('msg-box'); box.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data(); const isMe = m.uid === auth.currentUser.uid;
                    box.innerHTML += `<div class="msg ${isMe ? 'msg-me' : 'msg-them'}">${m.text}</div>`;
                });
                box.scrollTo(0, box.scrollHeight);
            });
        };

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault(); const i = document.getElementById('chat-input');
            if(!i.value.trim() || !activeFriendId) return;
            const cid = [auth.currentUser.uid, activeFriendId].sort().join('_');
            const payload = { text: i.value, uid: auth.currentUser.uid, name: currentUserData.name, createdAt: serverTimestamp() };
            await addDoc(collection(db, `chats/${cid}/messages`), payload);
            await addDoc(collection(db, "global_messages"), payload);
            i.value = '';
        };

        // --- PEOPLE ---
        async function loadUsers() {
            const snap = await getDocs(collection(db, "users"));
            const list = document.getElementById('users-list'); list.innerHTML = '';
            snap.forEach(d => {
                const u = d.data(); if(u.uid === auth.currentUser.uid) return;
                list.innerHTML += `<div class="bg-white p-4 rounded shadow-sm flex items-center justify-between"><div class="flex items-center gap-2"><img src="${u.photo}" class="w-8 h-8 rounded-full object-cover"><span class="text-xs font-bold">${u.name}</span></div><button onclick="sendReq('${u.uid}')" class="text-[10px] font-black text-teal-600">ADD</button></div>`;
            });
            onSnapshot(query(collection(db, "friendRequests"), where("to", "==", auth.currentUser.uid)), (snap) => {
                const rl = document.getElementById('req-list'); rl.innerHTML = '';
                snap.forEach(d => { rl.innerHTML += `<div class="bg-white p-4 rounded flex justify-between items-center"><span class="text-xs font-bold">${d.data().fromName}</span><button onclick="acceptReq('${d.id}', '${d.data().from}')" class="bg-orange-600 text-white text-[10px] px-2 py-1 rounded">OK</button></div>`; });
            });
        }
        window.sendReq = async (id) => { await addDoc(collection(db, "friendRequests"), { from: auth.currentUser.uid, fromName: currentUserData.name, to: id }); toast("Запрос улетел"); };
        window.acceptReq = async (rid, fid) => {
            await setDoc(doc(db, `users/${auth.currentUser.uid}/friends`, fid), { uid: fid });
            await setDoc(doc(db, `users/${fid}/friends`, auth.currentUser.uid), { uid: auth.currentUser.uid });
            await deleteDoc(doc(db, "friendRequests", rid));
            toast("Друг добавлен!");
        };

        // --- FEED ---
        document.getElementById('post-btn').onclick = async () => {
            const f = document.getElementById('feed-file').files[0]; const t = document.getElementById('feed-text').value;
            let url = null;
            const postData = { content: t, video: null, uid: auth.currentUser.uid, name: currentUserData.name, photo: currentUserData.photo, createdAt: serverTimestamp() };
            if(f) {
                const r = ref(storage, `v/${Date.now()}`); const task = uploadBytesResumable(r, f);
                task.on('state_changed', null, null, async () => {
                    postData.video = await getDownloadURL(task.snapshot.ref);
                    await addDoc(collection(db, "posts"), postData);
                });
            } else { await addDoc(collection(db, "posts"), postData); }
            document.getElementById('feed-text').value = '';
        };

        function loadFeed() {
            onSnapshot(query(collection(db, "posts"), orderBy("createdAt", "desc")), (snap) => {
                const fi = document.getElementById('feed-items'); fi.innerHTML = '';
                snap.forEach(d => {
                    const p = d.data();
                    // ЖЕСТКОЕ УСЛОВИЕ: если нет uid (старый пост), пишем undefined
                    const authorName = p.uid ? p.name : "undefined";
                    const authorPhoto = p.uid ? p.photo : "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                    
                    fi.innerHTML += `<div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex items-center gap-3 mb-4"><img src="${authorPhoto}" class="w-8 h-8 rounded-full object-cover"><span class="font-black text-xs">${authorName}</span></div>
                        <p class="text-sm mb-4">${p.content || ""}</p>
                        ${p.video ? `<video src="${p.video}" controls class="w-full rounded-lg"></video>` : ''}
                    </div>`;
                });
            });
        }

        // --- SCHOOL ---
        window.addS = () => { schoolData.schedule.push({n:document.getElementById('s-n').value, t:document.getElementById('s-t').value}); renderL(); };
        window.addG = () => { schoolData.grades.push({n:document.getElementById('g-n').value, v:document.getElementById('g-v').value}); renderL(); };
        function renderL() {
            document.getElementById('sch-view').innerHTML = schoolData.schedule.map(i => `<div class="flex justify-between p-2 bg-gray-50 text-[10px] font-bold"><span>${i.n}</span><span>${i.t}</span></div>`).join('');
            document.getElementById('g-view').innerHTML = schoolData.grades.map(i => `<div class="flex justify-between p-2 bg-gray-50 text-[10px] font-bold"><span>${i.n}</span><span class="text-green-600">${i.v}</span></div>`).join('');
        }
        window.exportExcel = () => {
            let csv = "Subject,Grade\n" + schoolData.grades.map(g => `${g.n},${g.v}`).join("\n");
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'school.csv'; a.click();
        };
    </script>
</body>
</html>
