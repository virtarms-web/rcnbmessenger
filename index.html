<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>RCNB OFFICIAL | VOICE FIX</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #0e1621; --side: #17212b; --accent: #24a1de; --online: #4cc351; --msg-my: #2b5278; --msg-his: #182533; }
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', Roboto; background: var(--bg); color: #fff; overflow: hidden; }
        #app { display: none; height: 100vh; grid-template-columns: 320px 1fr; }
        .sidebar { background: var(--side); border-right: 1px solid #000; display: flex; flex-direction: column; }
        .user-item { display: flex; align-items: center; padding: 12px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .user-item:hover { background: #202b36; }
        .avatar { position: relative; width: 45px; height: 45px; margin-right: 12px; }
        .avatar img { width: 100%; height: 100%; border-radius: 50%; }
        .dot { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--side); background: #555; }
        .dot.on { background: var(--online); box-shadow: 0 0 10px var(--online); }
        .chat { display: flex; flex-direction: column; position: relative; }
        .chat-header { height: 60px; background: var(--side); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #000; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: #0e1621; }
        .msg { max-width: 70%; padding: 8px 14px; border-radius: 12px; font-size: 15px; }
        .msg.my { align-self: flex-end; background: var(--msg-my); }
        .msg.his { align-self: flex-start; background: var(--msg-his); }
        .input-area { padding: 15px; background: var(--side); display: flex; gap: 10px; }
        input { flex: 1; background: #242f3d; border: none; padding: 10px 15px; border-radius: 8px; color: #fff; outline: none; }
        
        /* CALL UI 2018 ELITE */
        #call-ui { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 120px; position: absolute; top: 20px; right: 20px; border-radius: 10px; border: 1px solid var(--accent); }
        .call-info { position: absolute; top: 15%; text-align: center; z-index: 10; }
        .call-btns { position: absolute; bottom: 10%; display: flex; gap: 40px; z-index: 10; }
        .c-btn { width: 65px; height: 65px; border-radius: 50%; border: none; color: #fff; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        #login { display: flex; height: 100vh; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="login"><button onclick="login()" style="padding:15px 40px; border-radius:10px; background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:bold;">ВОЙТИ В RCNB</button></div>

<div id="app">
    <div class="sidebar">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #000;">RCNB OFFICIAL</div>
        <div id="u-list"></div>
    </div>
    <div class="chat">
        <div class="chat-header">
            <b id="chat-with">Чат не выбран</b>
            <div id="call-box" style="display:none; margin-left:auto; gap:20px;">
                <i class="fa fa-phone" onclick="startCall(false)" style="color:var(--accent); cursor:pointer"></i>
                <i class="fa fa-video" onclick="startCall(true)" style="color:var(--accent); cursor:pointer"></i>
            </div>
        </div>
        <div class="messages" id="msgs"></div>
        <div class="input-area"><input type="text" id="m-in" placeholder="Сообщение..." onkeypress="if(event.key==='Enter') send()"></div>
    </div>
</div>

<div id="call-ui">
    <div class="call-info">
        <img id="call-img" src="" style="width:120px; height:120px; border-radius:50%; margin-bottom:15px;">
        <h2 id="call-name">Имя</h2>
        <p id="call-status">Вызов...</p>
    </div>
    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay playsinline muted></video>
    <div class="call-btns">
        <button id="ans-btn" class="c-btn" style="background:var(--online); display:none;"><i class="fa fa-phone"></i></button>
        <button onclick="hangUp()" class="c-btn" style="background:#f44336;"><i class="fa fa-phone-slash"></i></button>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDch7p3qsay4twoc3GcXI2Z7YI5iHazuHs",
    authDomain: "rcnb-messenger.firebaseapp.com",
    projectId: "rcnb-messenger",
    storageBucket: "rcnb-messenger.firebasestorage.app",
    messagingSenderId: "131047901393",
    appId: "1:131047901393:web:d6f5ae21a875b6aef75df0"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore();
let me = null, activePeer = null, pc = null, localStream = null;

auth.onAuthStateChanged(u => {
    if(u) {
        me = u; document.getElementById('login').style.display='none'; document.getElementById('app').style.display='grid';
        db.collection("users").doc(u.uid).set({name: u.displayName, photo: u.photoURL, uid: u.uid, online: true}, {merge:true});
        window.onbeforeunload = () => db.collection("users").doc(me.uid).update({online: false});
        loadUsers(); listenCalls();
    }
});

function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

function loadUsers() {
    db.collection("users").onSnapshot(snap => {
        const list = document.getElementById('u-list'); list.innerHTML = "";
        snap.forEach(doc => {
            const u = doc.data(); if(u.uid === me.uid) return;
            list.innerHTML += `
                <div class="user-item" onclick="openChat('${u.uid}','${u.name}','${u.photo}')">
                    <div class="avatar"><img src="${u.photo}"><div class="dot ${u.online?'on':''}"></div></div>
                    <div><b>${u.name}</b><br><small style="color:#708499">${u.online?'в сети':'оффлайн'}</small></div>
                </div>`;
        });
    });
}

function openChat(id, name, photo) {
    activePeer = id; document.getElementById('chat-with').innerText = name;
    document.getElementById('call-box').style.display = 'flex';
    document.getElementById('call-name').innerText = name;
    document.getElementById('call-img').src = photo;
    const cid = [me.uid, id].sort().join('_');
    db.collection("chats").doc(cid).collection("messages").orderBy("time").onSnapshot(s => {
        const b = document.getElementById('msgs'); b.innerHTML = "";
        s.forEach(m => { const d = m.data(); b.innerHTML += `<div class="msg ${d.from===me.uid?'my':'his'}">${d.txt}</div>`; });
        b.scrollTop = b.scrollHeight;
    });
}

function send() {
    const i = document.getElementById('m-in'); if(!i.value || !activePeer) return;
    const cid = [me.uid, activePeer].sort().join('_');
    db.collection("chats").doc(cid).collection("messages").add({from: me.uid, txt: i.value, time: Date.now()});
    i.value = "";
}

// CALL ENGINE FIX
async function startCall(video) {
    document.getElementById('call-ui').style.display = 'flex';
    localStream = await navigator.mediaDevices.getUserMedia({audio: true, video: video});
    document.getElementById('local-video').srcObject = localStream;
    document.getElementById('local-video').style.display = video ? 'block' : 'none';

    pc = new RTCPeerConnection({iceServers: [{urls:'stun:stun.l.google.com:19302'}]});
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.ontrack = e => {
        const remoteVid = document.getElementById('remote-video');
        if (remoteVid.srcObject !== e.streams[0]) {
            remoteVid.srcObject = e.streams[0];
            remoteVid.style.display = 'block';
            console.log("Stream received with tracks:", e.tracks);
        }
    };

    const callRef = db.collection('calls').doc(activePeer);
    pc.onicecandidate = e => e.candidate && callRef.collection('cands').add(e.candidate.toJSON());
    
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await callRef.set({offer, fromName: me.displayName, video, fromPhoto: me.photoURL});

    callRef.onSnapshot(s => {
        const d = s.data();
        if(d?.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(d.answer));
    });
    callRef.collection('cands').onSnapshot(s => s.docChanges().forEach(c => c.type==='added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
}

function listenCalls() {
    db.collection('calls').doc(me.uid).onSnapshot(async s => {
        const d = s.data();
        if(d && d.offer && !pc) {
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('call-name').innerText = d.fromName;
            document.getElementById('call-img').src = d.fromPhoto;
            document.getElementById('ans-btn').style.display = 'flex';
            document.getElementById('ans-btn').onclick = async () => {
                document.getElementById('ans-btn').style.display = 'none';
                localStream = await navigator.mediaDevices.getUserMedia({audio: true, video: d.video});
                document.getElementById('local-video').srcObject = localStream;
                document.getElementById('local-video').style.display = d.video ? 'block' : 'none';

                pc = new RTCPeerConnection({iceServers: [{urls:'stun:stun.l.google.com:19302'}]});
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
                pc.ontrack = e => {
                    const remoteVid = document.getElementById('remote-video');
                    remoteVid.srcObject = e.streams[0];
                    remoteVid.style.display = 'block';
                };

                const callRef = db.collection('calls').doc(me.uid);
                pc.onicecandidate = e => e.candidate && callRef.collection('cands').add(e.candidate.toJSON());
                await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
                const ans = await pc.createAnswer();
                await pc.setLocalDescription(ans);
                await callRef.update({answer: ans});
                callRef.collection('cands').onSnapshot(s => s.docChanges().forEach(c => c.type==='added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
            };
        }
        if(!d && pc) hangUp();
    });
}

function hangUp() {
    if(pc) pc.close();
    if(localStream) localStream.getTracks().forEach(t => t.stop());
    pc = null; localStream = null;
    db.collection('calls').doc(me.uid).delete();
    db.collection('calls').doc(activePeer || 'null').delete();
    document.getElementById('call-ui').style.display = 'none';
    document.getElementById('remote-video').srcObject = null;
}
</script>
</body>
</html>
